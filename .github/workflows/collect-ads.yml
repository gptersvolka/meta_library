name: Collect Meta Ads

on:
  # 월요일, 금요일 오전 9시 (KST) = UTC 0시
  schedule:
    - cron: '0 0 * * 1,5'
  # 수동 실행 가능
  workflow_dispatch:
    inputs:
      query:
        description: '검색 키워드 (비워두면 keywords.json 사용)'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install chromium

      - name: Ensure data directories exist
        run: mkdir -p data/raw

      - name: Run collection pipeline
        env:
          IMGBB_API_KEY: ${{ secrets.IMGBB_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          MANUAL_QUERY: ${{ github.event.inputs.query }}
        run: |
          # Python 스크립트에서 Supabase 키워드를 직접 읽어서 처리
          # (공백이 포함된 키워드도 정상 처리)
          python -m src.collect_all_keywords

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 변경사항이 있는지 확인
          if [ -n "$(git status --porcelain data/)" ]; then
            git add data/
            git commit -m "chore: 광고 수집 자동화 $(date +'%Y-%m-%d %H:%M') KST"
            git push
            echo "Changes committed and pushed"
          else
            echo "No changes to commit"
          fi
