name: Collect Meta Ads

on:
  # 월요일, 금요일 오전 9시 (KST) = UTC 0시
  schedule:
    - cron: '0 0 * * 1,5'
  # 수동 실행 가능
  workflow_dispatch:
    inputs:
      query:
        description: '검색 키워드 (비워두면 keywords.json 사용)'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install chromium

      - name: Ensure data directories exist
        run: mkdir -p data/raw

      - name: Run collection pipeline
        env:
          IMGBB_API_KEY: ${{ secrets.IMGBB_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          # 수동 실행 시 입력된 키워드 사용
          if [ -n "${{ github.event.inputs.query }}" ]; then
            KEYWORDS="${{ github.event.inputs.query }}"
            echo "Manual trigger with keyword: $KEYWORDS"
          else
            # Supabase에서 키워드 읽기
            echo "Reading keywords from Supabase..."
            KEYWORDS=$(python -c "
          import os
          from supabase import create_client
          url = os.getenv('SUPABASE_URL')
          key = os.getenv('SUPABASE_KEY')
          if url and key:
              client = create_client(url, key)
              result = client.table('keywords').select('query').eq('enabled', True).execute()
              keywords = [r['query'] for r in result.data] if result.data else []
              print(' '.join(keywords))
          else:
              print('')
          " 2>/dev/null || echo "")

            # Supabase에서 못 읽으면 keywords.json 폴백
            if [ -z "$KEYWORDS" ] && [ -f "data/keywords.json" ]; then
              echo "Fallback: Reading from data/keywords.json"
              KEYWORDS=$(python -c "import json; data=json.load(open('data/keywords.json')); print(' '.join([k['query'] for k in data.get('keywords', []) if k.get('enabled', True)]))")
            fi
          fi

          if [ -z "$KEYWORDS" ]; then
            echo "No keywords found. Exiting."
            exit 0
          fi

          echo "Collecting ads for keywords: $KEYWORDS"

          # 각 키워드에 대해 수집 실행
          for keyword in $KEYWORDS; do
            echo "=== Collecting: $keyword ==="
            python -m src.07_run_weekly --query "$keyword" --limit 50 --headless --image-only || true
            sleep 5
          done

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 변경사항이 있는지 확인
          if [ -n "$(git status --porcelain data/)" ]; then
            git add data/
            git commit -m "chore: 광고 수집 자동화 $(date +'%Y-%m-%d %H:%M') KST"
            git push
            echo "Changes committed and pushed"
          else
            echo "No changes to commit"
          fi
